./fb-voicemailtools.sh <Aktion> [Optionen]```

**Beispiele:**

*   **Alle Nachrichten auflisten (Tabelle):**
    ```bash
    ./fb-voicemailtools.sh --list
    ```
*   **Neueste Nachricht im Simple-Format anzeigen:**
    ```bash
    ./fb-voicemailtools.sh --list latest --format simple
    ```
*   **Nachrichten von unbekannten Anrufern als CSV speichern (nur Daten):**
    ```bash
    ./fb-voicemailtools.sh --list unknown --format csv > unbekannt.csv
    ```
    *(Oder: `./fb-voicemailtools.sh --list unknown --format csv --output-file unbekannt.csv`)*
*   **Nachricht mit Index 5 herunterladen und als OGG speichern:**
    ```bash
    ./fb-voicemailtools.sh --download 5 --output nachricht_5.ogg
    ```
*   **Alle Nachrichten von TAM 1 als MP3 herunterladen (ben√∂tigt `--audio-format`):**
    ```bash
    mkdir ./tam1_mp3
    ./fb-voicemailtools.sh --download all --tam 1 --output ./tam1_mp3/ --audio-format mp3
    ```
*   **Download mit ausf√ºhrlichem Debugging (inkl. curl -v):**
    ```bash
    ./fb-voicemailtools.sh --download latest --output test.wav -v
    ```

### Bekannte Probleme / Einschr√§nkungen

*   **Malformed HTML:** Das Skript verwendet Regex zum Parsen, da das von `data.lua` gelieferte HTML strukturelle Fehler enthalten kann, die Standard-Parser zum Scheitern bringen. Zuk√ºnftige √Ñnderungen am Fritz!OS-Webinterface k√∂nnten den Regex-Parser unbrauchbar machen.
*   **"Bekannt?"-Status:** Die Anzeige, ob ein Anrufer im Telefonbuch "bekannt" ist, basiert darauf, ob der entsprechende Button im Webinterface aktiv ist. Es gibt Berichte, dass diese Anzeige auf der Fritz!Box selbst nicht immer 100% korrekt ist (z.B. bei internen Nummern). Das Skript spiegelt den Zustand des Webinterfaces wider.
*   **Download `all` + Konvertierung:** Die automatische Konvertierung √ºber die Dateiendung von `--output` funktioniert nur f√ºr `latest` und `index`. F√ºr `--download all` muss das Zielformat explizit mit `--audio-format <ogg|mp3>` angegeben werden, wenn eine Konvertierung gew√ºnscht ist.

### Lizenz

Dieses Projekt steht unter der [MIT Lizenz](LICENSE). (F√ºge ggf. eine LICENSE-Datei hinzu)

### Danksagung

Ein besonderer Dank geht an [Dein Name/Nickname], dessen unerm√ºdliches Testen und pr√§zises Feedback entscheidend f√ºr die Entwicklung und Fehlersuche dieses Skripts waren!

---

## <a name="english"></a>English üá¨üáß

### Introduction

This script allows listing and downloading voicemail messages from an AVM Fritz!Box using its web interface (Web Scraping). It serves as an alternative in cases where the TR-064 interface is unreliable or not desired.

This set of bash scripts interacts with your Fritz!Box's web interface to access voicemail messages stored on a connected USB drive or internal memory. It logs in, retrieves the message list from an internal Lua page (`data.lua`), and parses it to display the list or download the corresponding audio files. As the HTML provided by the Fritz!Box can sometimes be malformed, robust regex methods (awk, grep) are used for parsing.

### Features

*   **List (`--list`):** Displays voicemail messages.
    *   **Filters:** `all` (default), `latest`, `<index>` (specific message), `known` (caller in phonebook), `unknown` (caller not in phonebook).
    *   **Formats (`--format`):**
        *   `table`: Human-readable table (requires `column`).
        *   `simple`: One line per message with key-value pairs.
        *   `json`: Output in JSON format (requires `jq`).
        *   `csv`: Semicolon-separated values, suitable for spreadsheets.
    *   **Clean Output:** Output to file (`--output-file`) or via pipe (`|`)/redirection (`>`) contains only the raw data (no headers/logs).
*   **Download (`--download`):** Downloads voice messages.
    *   **Selection:** `latest`, `<index>`, `all` (all messages on the selected answering machine).
    *   **Target:** Single file or directory (`--output`).
    *   **Audio Format (`--audio-format`):** Explicitly select the target format (`wav`, `ogg`, `mp3`). Requires `ffmpeg` for `ogg`/`mp3`.
    *   **Automatic Conversion:** For `--download latest|index`, the target format is also detected from the `--output` file extension (e.g., `--output call.mp3`). `--audio-format` takes precedence. For `--download all`, the default is `wav` unless `--audio-format` is specified.
*   **Answering Machine Selection (`--tam <index>`):** Selects the desired answering machine (default: 0).
*   **Verbose Logging (`-v`, `--verbose`):** Shows detailed debug information on Stderr.
*   **Clean Exit:** Correct handling of Ctrl+C (SIGINT) including Fritz!Box logout.
*   **Modular Structure:** Divided into a library (`fb_lib.sh`), parser (`_parse_voicemail_html.sh`), and main script (`fb-voicemailtools.sh`).

### Prerequisites

*   **Bash:** Version 4+ recommended (due to `mapfile`).
*   **Core Tools:** `curl`, `md5sum`, `iconv`, `awk`, `grep` (GNU version with `-P` support recommended), `sed`, `file`. These are standard on most Linux systems.
*   **Optional:**
    *   `jq`: Required for `--format json` and internally for downloads (`jq` is used for URL encoding). **Practically mandatory for downloads.**
    *   `column`: Required for nicely formatted `--format table` output.
    *   `ffmpeg`: Required for audio conversion to `.ogg` or `.mp3`.
*   **Configuration File:** A file named `fb-credentials` in the same directory as the scripts.

### Installation

1.  **Clone or Download:**
    ```bash
    git clone <repository_url> # Or download the .sh files
    cd <repository_directory>
    ```
2.  **Make Executable:**
    ```bash
    chmod +x fb_lib.sh _parse_voicemail_html.sh fb-voicemailtools.sh
    ```
3.  **Create Configuration File:**
    *   Copy the example file (if provided) or create a new file `fb-credentials`.
    *   ```bash
      # Example: cp fb-credentials.example fb-credentials
      nano fb-credentials
      ```
    *   Add your Fritz!Box details (see next section).
4.  **Set Permissions for Config File (Recommended):**
    ```bash
    chmod 600 fb-credentials
    ```

### Configuration (`fb-credentials`)

The `fb-credentials` file must contain the following lines:

```ini
# URL of your Fritz!Box (including http:// or https://)
FRITZBOX_URL="http://fritz.box"

# Username for Fritz!Box login.
# Leave the value empty if you only use a password to log in.
# Important: The user needs the "Fritz!Box Settings" permission.
FRITZBOX_USER="my_user"

# Password for Fritz!Box login.
FRITZBOX_PASSWORD="my_super_secret_password"